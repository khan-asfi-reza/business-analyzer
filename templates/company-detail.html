<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company.company_name }} - Business Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/assets/css/main.css">
    <style>
        /* Markdown styling for chatbot messages */
        .chat-markdown p {
            margin-bottom: 0.5rem;
        }
        .chat-markdown p:last-child {
            margin-bottom: 0;
        }
        .chat-markdown ul, .chat-markdown ol {
            margin-left: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .chat-markdown li {
            margin-bottom: 0.25rem;
        }
        .chat-markdown strong {
            font-weight: 600;
        }
        .chat-markdown em {
            font-style: italic;
        }
        .chat-markdown code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: monospace;
        }
        .chat-markdown pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 0.5rem;
        }
        .chat-markdown pre code {
            background-color: transparent;
            padding: 0;
        }
        .chat-markdown h1, .chat-markdown h2, .chat-markdown h3 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .chat-markdown h1 {
            font-size: 1.125rem;
        }
        .chat-markdown h2 {
            font-size: 1rem;
        }
        .chat-markdown h3 {
            font-size: 0.875rem;
        }
        .chat-markdown a {
            color: #2563eb;
            text-decoration: underline;
        }
        .chat-markdown blockquote {
            border-left: 3px solid #e2e8f0;
            padding-left: 0.75rem;
            margin-left: 0;
            color: #64748b;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-b from-slate-50 to-slate-100">
    <!-- Navigation -->
    {% include "components/navigation.html" %}

    <!-- Main Content -->
    <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <!-- Header -->
            <div class="bg-white rounded-xl border border-slate-200 p-8 mb-8">
                <div class="flex items-start justify-between mb-6">
                    <div class="flex gap-6">
                        {% if company.logo_url %}
                        <img src="{{ company.logo_url }}" alt="{{ company.company_name }}" class="w-20 h-20 rounded-lg object-cover" />
                        {% else %}
                        <div class="w-20 h-20 rounded-lg bg-blue-100 flex items-center justify-center">
                            <i data-lucide="building-2" class="w-10 h-10 text-blue-600"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h1 class="text-4xl font-bold text-slate-900 mb-2">{{ company.company_name }}</h1>
                            <div class="flex gap-3 flex-wrap">
                                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">{{ company.company_type|title }}</span>
                                <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm font-medium">{{ company.industry }}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleBookmark()" id="bookmarkBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition {% if is_bookmarked %}bg-blue-600 text-white hover:bg-blue-700{% else %}bg-slate-100 text-slate-900 hover:bg-slate-200{% endif %}">
                        <i data-lucide="{% if is_bookmarked %}bookmark-check{% else %}bookmark{% endif %}" class="w-5 h-5"></i>
                        <span>{% if is_bookmarked %}In Watchlist{% else %}Add to Watchlist{% endif %}</span>
                    </button>
                </div>

                <div class="grid md:grid-cols-3 gap-6 pt-6 border-t border-slate-200">
                    <div>
                        <p class="text-slate-600 text-sm mb-1">Founded</p>
                        <p class="text-lg font-semibold text-slate-900">{% if company.founded_date %}{{ company.founded_date.year }}{% else %}N/A{% endif %}</p>
                    </div>
                    <div>
                        <p class="text-slate-600 text-sm mb-1">Market Cap</p>
                        <p class="text-lg font-semibold text-slate-900">{% if company.market_cap %}{{ company.market_cap }}{% else %}N/A{% endif %}</p>
                    </div>
                    <div>
                        <p class="text-slate-600 text-sm mb-1">Description</p>
                        <p class="text-slate-700">{% if company.description %}{{ company.description }}{% else %}No description available{% endif %}</p>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <!-- Price Trend Chart -->
                    <div class="bg-white rounded-xl border border-slate-200 p-8 mb-8">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Price Trend</h2>
                        <div class="mb-6">
                            <div class="flex items-baseline gap-2 mb-6">
                                {% if latest_price %}
                                <span class="text-4xl font-bold text-slate-900">{{ "%.2f"|format(latest_price.close_price) }} {{ latest_price.currency }}</span>
                                {% else %}
                                <span class="text-4xl font-bold text-slate-900">N/A</span>
                                {% endif %}
                            </div>

                            <!-- Chart.js Visualization -->
                            {% if price_history and price_history|length > 0 %}
                            <div class="relative" style="height: 300px;">
                                <canvas id="priceChart"></canvas>
                            </div>
                            {% else %}
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
                                <p class="text-slate-600">No price history available</p>
                            </div>
                            {% endif %}
                        </div>
                        <p class="text-sm text-slate-600">Chart showing last 30 days of price data.</p>
                    </div>

                    <!-- Financial Summary -->
                    <div class="bg-white rounded-xl border border-slate-200 p-8 mb-8">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Financial Summary</h2>
                        {% if financial_statement %}
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <p class="text-slate-600 text-sm mb-2">Revenue</p>
                                <p class="text-3xl font-bold text-slate-900 mb-1">{{ "%.2f"|format(financial_statement.revenue / 1000000000) }}B {{ financial_statement.currency }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm mb-2">Profit</p>
                                <p class="text-3xl font-bold text-slate-900 mb-1">{{ "%.2f"|format(financial_statement.profit / 1000000000) }}B {{ financial_statement.currency }}</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mt-6 pt-6 border-t border-slate-200">
                            Period: {{ financial_statement.statement_type|title }}
                            ({{ financial_statement.period_start_date }} to {{ financial_statement.period_end_date }})
                        </p>
                        {% else %}
                        <p class="text-slate-600">No financial data available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <!-- Sentiment Card -->
                    {% if sentiment %}
                    <div class="bg-white rounded-xl border border-slate-200 p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Sentiment</h3>
                        <div class="mb-4">
                            {% if sentiment.label == 'positive' %}
                            <span class="px-4 py-2 rounded-full font-semibold text-white bg-green-600">Positive</span>
                            {% elif sentiment.label == 'negative' %}
                            <span class="px-4 py-2 rounded-full font-semibold text-white bg-red-600">Negative</span>
                            {% else %}
                            <span class="px-4 py-2 rounded-full font-semibold text-white bg-gray-600">Neutral</span>
                            {% endif %}
                        </div>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-slate-600 mb-1">Sentiment Score</p>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-200 rounded-full h-2">
                                        <div class="{% if sentiment.label == 'positive' %}bg-green-500{% elif sentiment.label == 'negative' %}bg-red-500{% else %}bg-gray-500{% endif %} h-2 rounded-full" style="width: {{ sentiment.score|int }}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">{{ sentiment.score|int }}%</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs text-slate-600 mb-1">Confidence</p>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: {{ sentiment.confidence|int }}%"></div>
                                    </div>
                                    <span class="text-sm font-bold">{{ sentiment.confidence|int }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Recommendation Card -->
                    {% if recommendation %}
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">AI Recommendation</h3>
                        <div class="mb-4">
                            {% if recommendation.recommendation_type == 'invest' %}
                            <span class="px-4 py-2 rounded-full font-semibold bg-green-600 text-white text-sm">Invest</span>
                            {% elif recommendation.recommendation_type == 'hold' %}
                            <span class="px-4 py-2 rounded-full font-semibold bg-yellow-600 text-white text-sm">Hold</span>
                            {% elif recommendation.recommendation_type == 'wait' %}
                            <span class="px-4 py-2 rounded-full font-semibold bg-blue-600 text-white text-sm">Wait</span>
                            {% else %}
                            <span class="px-4 py-2 rounded-full font-semibold bg-red-600 text-white text-sm">Don't Invest</span>
                            {% endif %}
                        </div>
                        <div class="space-y-3 mb-4">
                            <div>
                                <p class="text-sm text-slate-600 mb-1">Risk Level</p>
                                {% if recommendation.risk_level == 'low' %}
                                <p class="font-bold text-green-600">Low</p>
                                {% elif recommendation.risk_level == 'medium' %}
                                <p class="font-bold text-yellow-600">Medium</p>
                                {% else %}
                                <p class="font-bold text-red-600">High</p>
                                {% endif %}
                            </div>
                            <div>
                                <p class="text-sm text-slate-600 mb-2">Investment Score</p>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 bg-white rounded-full h-3">
                                        <div class="{% if recommendation.investment_score >= 70 %}bg-green-500{% elif recommendation.investment_score >= 40 %}bg-yellow-500{% else %}bg-red-500{% endif %} h-3 rounded-full" style="width: {{ recommendation.investment_score|int }}%"></div>
                                    </div>
                                    <span class="text-lg font-bold">{{ recommendation.investment_score|int }}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-slate-700">
                            <strong>Why:</strong> {% if recommendation.rationale_summary %}{{ recommendation.rationale_summary }}{% else %}Based on current market analysis, financial performance, and sentiment data.{% endif %}
                        </p>
                    </div>
                    {% else %}
                    <div class="bg-slate-100 rounded-xl border border-slate-200 p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">AI Recommendation</h3>
                        <p class="text-slate-600">No recommendation available for this company yet.</p>
                    </div>
                    {% endif %}

                    <!-- Notes Section -->
                    <div class="bg-white rounded-xl border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Personal Notes</h3>
                        <textarea id="companyNotes" placeholder="Add your personal notes about this company..." class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-600 resize-none mb-3" rows="4">{{ existing_notes if existing_notes else '' }}</textarea>
                        <button onclick="saveNotes()" id="saveNotesBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatbot Floating Button -->
        <button id="chatbotToggle" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition z-40">
            <i data-lucide="message-circle" class="w-6 h-6"></i>
        </button>

        <!-- Chatbot Window -->
        <div id="chatbotWindow" class="fixed bottom-24 right-6 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 transform translate-y-full opacity-0 transition-all duration-300 z-40 hidden">
            <!-- Chat Header -->
            <div class="bg-blue-600 text-white p-4 rounded-t-xl flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="bot" class="w-5 h-5"></i>
                    <h3 class="font-bold">AI Investment Assistant</h3>
                </div>
                <button id="chatbotClose" class="text-white hover:bg-blue-700 rounded p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="h-96 overflow-y-auto p-4 space-y-4">
                <!-- Welcome Message -->
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="bot" class="w-4 h-4 text-blue-600"></i>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 max-w-xs">
                        <p class="text-sm text-slate-900">Hi! I'm your AI investment assistant. Ask me anything about {{ company.company_name }}!</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="border-t border-slate-200 p-4">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Ask about this company..." class="flex-1 px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-600 text-sm" />
                    <button id="chatSend" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->

    {% include "components/footer.html" %}
    {% include "components/script.html" %}
    <script>
        lucide.createIcons();

        let isBookmarked = {{ 'true' if is_bookmarked else 'false' }};

        async function toggleBookmark() {
            const btn = document.getElementById('bookmarkBtn');
            btn.disabled = true;

            try {
                if (isBookmarked) {
                    // Remove from watchlist - redirect to watchlist page to handle removal
                    window.location.href = '/dashboard/watchlist';
                } else {
                    // Add to watchlist
                    const formData = new FormData();
                    formData.append('company_id', {{ company.company_id }});

                    const response = await fetch('/api/bookmark/add', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok || response.redirected) {
                        // Update UI
                        isBookmarked = true;
                        btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg font-semibold transition bg-blue-600 text-white hover:bg-blue-700';
                        btn.innerHTML = '<i data-lucide="bookmark-check" class="w-5 h-5"></i><span>In Watchlist</span>';
                        lucide.createIcons();
                    } else {
                        alert('Failed to add to watchlist');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            } finally {
                btn.disabled = false;
            }
        }

        async function saveNotes() {
            const notes = document.getElementById('companyNotes').value;
            const btn = document.getElementById('saveNotesBtn');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const formData = new FormData();
                formData.append('company_id', {{ company.company_id }});
                formData.append('notes', notes);

                const response = await fetch('/api/bookmark/update-notes', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    btn.textContent = 'Saved!';
                    btn.className = 'w-full bg-green-600 text-white py-2 rounded-lg font-semibold';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.className = 'w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition';
                    }, 2000);
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to save notes. Make sure the item is in your watchlist first.');
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving notes');
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
            }
        }

        // Initialize Price Chart
        {% if price_history and price_history|length > 0 %}
        const priceData = {{ price_history[:60]|tojson }};
        const sortedData = priceData.reverse(); // Oldest to newest

        const ctx = document.getElementById('priceChart');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedData.map(p => p.date),
                datasets: [{
                    label: 'Close Price ({{ latest_price.currency if latest_price else "USD" }})',
                    data: sortedData.map(p => p.close_price),
                    borderColor: 'rgb(37, 99, 235)',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: 'rgb(37, 99, 235)',
                    pointHoverBorderColor: 'white',
                    pointHoverBorderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8,
                        titleColor: 'white',
                        bodyColor: 'white',
                        callbacks: {
                            label: function(context) {
                                return 'Price: ' + context.parsed.y.toFixed(2) + ' {{ latest_price.currency if latest_price else "USD" }}';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxTicksLimit: 10,
                            color: '#64748b'
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            color: '#64748b',
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        {% endif %}

        // Chatbot functionality
        let chatSessionId = localStorage.getItem('chatSession_{{ company.company_id }}') || null;
        let chatHistoryLoaded = false;
        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotWindow = document.getElementById('chatbotWindow');
        const chatbotClose = document.getElementById('chatbotClose');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });

        async function loadChatHistory() {
            if (chatHistoryLoaded) return;

            try {
                const url = chatSessionId
                    ? `/api/company/{{ company.company_id }}/chat/history?session_id=${chatSessionId}`
                    : `/api/company/{{ company.company_id }}/chat/history`;

                const response = await fetch(url);

                if (!response.ok) {
                    console.error('Failed to load chat history');
                    return;
                }

                const data = await response.json();

                // Clear welcome message if we have history
                if (data.history && data.history.length > 0) {
                    chatMessages.innerHTML = '';

                    // Display chat history
                    data.history.forEach(msg => {
                        addMessage(msg.message_text, msg.is_user_message);
                    });
                }

                chatHistoryLoaded = true;
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function toggleChatbot() {
            const isHidden = chatbotWindow.classList.contains('hidden');

            if (isHidden) {
                chatbotWindow.classList.remove('hidden');
                setTimeout(() => {
                    chatbotWindow.classList.remove('translate-y-full', 'opacity-0');
                }, 10);

                // Load chat history when opening
                await loadChatHistory();
            } else {
                chatbotWindow.classList.add('translate-y-full', 'opacity-0');
                setTimeout(() => {
                    chatbotWindow.classList.add('hidden');
                }, 300);
            }

            lucide.createIcons();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 ' + (isUser ? 'justify-end' : '');

            if (!isUser) {
                const renderedMarkdown = marked.parse(text);
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="bot" class="w-4 h-4 text-blue-600"></i>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 max-w-xs">
                        <div class="text-sm text-slate-900 chat-markdown">${renderedMarkdown}</div>
                    </div>
                `;
            } else {
                const escapedText = escapeHtml(text);
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 rounded-lg p-3 max-w-xs">
                        <p class="text-sm text-white">${escapedText}</p>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        }

        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex gap-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="bot" class="w-4 h-4 text-blue-600"></i>
                </div>
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            chatInput.value = '';
            chatSend.disabled = true;
            chatInput.disabled = true;

            addTypingIndicator();

            try {
                const response = await fetch(`/api/company/{{ company.company_id }}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: chatSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();
                removeTypingIndicator();

                chatSessionId = data.session_id;
                localStorage.setItem('chatSession_{{ company.company_id }}', chatSessionId);
                addMessage(data.answer, false);
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addMessage('Sorry, I encountered an error. Please try again.', false);
            } finally {
                chatSend.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        chatbotToggle.addEventListener('click', toggleChatbot);
        chatbotClose.addEventListener('click', toggleChatbot);
        chatSend.addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>